@let company = company$ | async;
@let roles = roles$ | async;
@let offices = offices$ | async;

@if (company) {
  <section class="mx-auto max-w-3xl space-y-6">
    <app-admin-breadcrumbs
      [items]="[
        { label: 'Companies', link: ['/admin/companies'] },
        { label: company.name, link: ['/admin/companies', company.id] },
        { label: 'Users', link: ['/admin/companies', company.id, 'users'] },
        { label: 'Create user' }
      ]"
    ></app-admin-breadcrumbs>

    <header class="space-y-2">
      <h1 class="text-3xl font-semibold text-slate-900">Create user for {{ company.name }}</h1>
      <p class="text-sm text-slate-500">
        Complete the form below to add a new user to this brokerage. All fields marked as required must be filled in.
      </p>
    </header>

    <article class="rounded-3xl border border-slate-200 bg-white p-8 shadow-sm">
      @if (roles === undefined || offices === undefined) {
        <div class="skeleton-wrapper">
          <div class="grid gap-6">
            @for (_ of skeletonFields; track $index) {
              <div class="skeleton skeleton--field"></div>
            }
          </div>
          <div class="flex flex-wrap justify-end gap-3">
            <div class="skeleton skeleton--button"></div>
            <div class="skeleton skeleton--button"></div>
          </div>
        </div>
      } @else {
        <form class="space-y-6" [formGroup]="form" (ngSubmit)="submit()">
          <section class="space-y-3 rounded-2xl border border-slate-200 bg-slate-50 p-5">
            <p class="text-sm font-semibold text-slate-700">Select ente source</p>
            <div class="grid gap-3 sm:grid-cols-2">
              <label
                class="flex cursor-pointer items-start gap-3 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm transition hover:border-sky-300"
                [ngClass]="{ 'ring-2 ring-sky-500 border-sky-300': !useExistingEnte() }"
              >
                <input
                  type="radio"
                  name="enteMode"
                  class="mt-1"
                  [checked]="!useExistingEnte()"
                  (change)="toggleUseExistingEnte(false)"
                  aria-label="Create new ente"
                />
                <span>
                  <span class="block text-sm font-semibold text-slate-900">Create new ente</span>
                  <span class="block text-xs text-slate-500">Add a new ente using the form below.</span>
                </span>
              </label>
              <label
                class="flex cursor-pointer items-start gap-3 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm transition hover:border-sky-300"
                [ngClass]="{ 'ring-2 ring-sky-500 border-sky-300': useExistingEnte() }"
              >
                <input
                  type="radio"
                  name="enteMode"
                  class="mt-1"
                  [checked]="useExistingEnte()"
                  (change)="toggleUseExistingEnte(true)"
                  aria-label="Assign existing ente"
                />
                <span>
                  <span class="block text-sm font-semibold text-slate-900">Assign existing ente</span>
                  <span class="block text-xs text-slate-500">Search by email and reuse an existing record.</span>
                </span>
              </label>
            </div>
          </section>

          @if (useExistingEnte()) {
            <section class="space-y-4 rounded-2xl border border-dashed border-sky-200 bg-sky-50 p-5">
              <header class="flex flex-col gap-1">
                <h2 class="text-sm font-semibold text-slate-900">Search ente by email</h2>
                <p class="text-xs text-slate-600">We will reuse the ente if it belongs to this company.</p>
              </header>
              <div class="flex flex-wrap items-end gap-3">
                <label
                  class="form-field w-full max-w-sm"
                  [ngClass]="{
                    'form-field--error':
                      existingEnteSearchControl.invalid &&
                      (existingEnteSearchControl.dirty || existingEnteSearchControl.touched)
                  }"
                >
                  <span class="form-field__label">Ente email</span>
                  <input
                    type="email"
                    class="form-field__input"
                    placeholder="ente@example.com"
                    [formControl]="existingEnteSearchControl"
                    [attr.aria-invalid]="
                      existingEnteSearchControl.invalid &&
                      (existingEnteSearchControl.dirty || existingEnteSearchControl.touched)
                    "
                  />
                  @if (
                    existingEnteSearchControl.invalid &&
                      (existingEnteSearchControl.dirty || existingEnteSearchControl.touched)
                  ) {
                    <span class="form-field__error">
                      {{
                        existingEnteSearchControl.hasError('email')
                          ? 'Enter a valid email address.'
                          : 'Email is required.'
                      }}
                    </span>
                  }
                </label>
                <button
                  type="button"
                  class="inline-flex items-center gap-2 rounded-full bg-sky-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-sky-700 disabled:cursor-not-allowed disabled:opacity-70"
                  (click)="searchExistingEnte()"
                  [disabled]="isSearchingEnte()"
                >
                  @if (isSearchingEnte()) {
                    <span>Searching...</span>
                  } @else {
                    <span>Search</span>
                  }
                </button>
                <button
                  type="button"
                  class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-300 hover:bg-white disabled:cursor-not-allowed disabled:opacity-70"
                  (click)="resetExistingEnteSearch()"
                  [disabled]="isSearchingEnte()"
                >
                  Reset search
                </button>
              </div>
              @if (enteSearchError(); as error) {
                <p class="text-xs font-medium text-red-600">{{ error }}</p>
              }
              @if (selectedExistingEnte(); as selected) {
                <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                  <header class="flex items-center justify-between gap-3">
                    <div>
                      <p class="text-sm font-semibold text-slate-900">{{ selected.nombre }}</p>
                      <p class="text-xs text-slate-500">{{ selected.correo }}</p>
                    </div>
                    <button
                      type="button"
                      class="text-xs font-semibold text-sky-600 hover:text-sky-700"
                      (click)="clearExistingEnteSelection()"
                    >
                      Remove
                    </button>
                  </header>
                  <dl class="mt-3 grid gap-2 text-xs text-slate-600 sm:grid-cols-2">
                    <div>
                      <dt class="font-semibold text-slate-500">Document</dt>
                      <dd>{{ selected.tipo_documento }} {{ selected.documento }}</dd>
                    </div>
                    <div>
                      <dt class="font-semibold text-slate-500">Phone</dt>
                      <dd>{{ selected.telefono || '—' }}</dd>
                    </div>
                    <div>
                      <dt class="font-semibold text-slate-500">Address</dt>
                      <dd>{{ selected.direccion || '—' }}</dd>
                    </div>
                    <div>
                      <dt class="font-semibold text-slate-500">Status</dt>
                      <dd>{{ selected.activo ? 'Active' : 'Inactive' }}</dd>
                    </div>
                  </dl>
                </article>
              } @else {
                @if (!isSearchingEnte()) {
                  @if (enteSearchResults().length > 0) {
                    <div class="grid gap-3">
                      @for (ente of enteSearchResults(); track ente.id) {
                        <button
                          type="button"
                          class="w-full rounded-2xl border border-slate-200 bg-white p-4 text-left shadow-sm transition hover:border-sky-300"
                          (click)="selectExistingEnte(ente)"
                        >
                          <p class="text-sm font-semibold text-slate-900">{{ ente.nombre }}</p>
                          <p class="text-xs text-slate-500">{{ ente.correo }}</p>
                          <p class="mt-1 text-xs text-slate-500">
                            {{ ente.tipo_documento }} {{ ente.documento }}
                          </p>
                        </button>
                      }
                    </div>
                  } @else if (existingEnteSearchControl.value) {
                    <p class="text-xs text-slate-600">No ente was found with that email.</p>
                  } @else {
                    <p class="text-xs text-slate-600">Search for an ente email to reuse it.</p>
                  }
                }
              }
            </section>
          }

          <div class="grid gap-6">
          <label
            class="form-field"
            [ngClass]="{ 'form-field--error': isFieldInvalid('firstName') }"
          >
            <span class="form-field__label">First name</span>
            <input
              type="text"
              formControlName="firstName"
              class="form-field__input"
              [ngClass]="{ 'form-field__input--invalid': isFieldInvalid('firstName') }"
              [attr.aria-invalid]="isFieldInvalid('firstName')"
            />
            @if (getFieldError('firstName'); as error) {
              <span class="form-field__error">{{ error }}</span>
            }
          </label>

          <label
            class="form-field"
            [ngClass]="{ 'form-field--error': isFieldInvalid('lastName') }"
          >
            <span class="form-field__label">Last name</span>
            <input
              type="text"
              formControlName="lastName"
              class="form-field__input"
              [ngClass]="{ 'form-field__input--invalid': isFieldInvalid('lastName') }"
              [attr.aria-invalid]="isFieldInvalid('lastName')"
            />
            @if (getFieldError('lastName'); as error) {
              <span class="form-field__error">{{ error }}</span>
            }
          </label>

          <label
            class="form-field"
            [ngClass]="{ 'form-field--error': isFieldInvalid('email') }"
          >
            <span class="form-field__label">Email</span>
            <input
              type="email"
              formControlName="email"
              class="form-field__input"
              autocomplete="email"
              [ngClass]="{ 'form-field__input--invalid': isFieldInvalid('email') }"
              [attr.aria-invalid]="isFieldInvalid('email')"
            />
            @if (getFieldError('email'); as error) {
              <span class="form-field__error">{{ error }}</span>
            }
          </label>

          <label
            class="form-field"
            [ngClass]="{ 'form-field--error': isFieldInvalid('role') }"
          >
            <span class="form-field__label">Role</span>
            <select
              formControlName="role"
              class="form-field__input"
              [ngClass]="{ 'form-field__input--invalid': isFieldInvalid('role') }"
              [attr.aria-invalid]="isFieldInvalid('role')"
            >
              <option value="" disabled>Select role</option>
              @for (role of roles ?? []; track role.rol) {
                <option [value]="role.rol">{{ role.descripcion || role.rol }}</option>
              }
            </select>
            @if (getFieldError('role'); as error) {
              <span class="form-field__error">{{ error }}</span>
            }
          </label>

          <label
            class="form-field"
            [ngClass]="{ 'form-field--error': isFieldInvalid('documentType') }"
          >
            <span class="form-field__label">Document type</span>
            <input
              type="text"
              formControlName="documentType"
              class="form-field__input"
              [ngClass]="{ 'form-field__input--invalid': isFieldInvalid('documentType') }"
              [attr.aria-invalid]="isFieldInvalid('documentType')"
            />
            @if (getFieldError('documentType'); as error) {
              <span class="form-field__error">{{ error }}</span>
            }
          </label>

          <label
            class="form-field"
            [ngClass]="{ 'form-field--error': isFieldInvalid('documentNumber') }"
          >
            <span class="form-field__label">Document number</span>
            <input
              type="text"
              formControlName="documentNumber"
              class="form-field__input"
              [ngClass]="{ 'form-field__input--invalid': isFieldInvalid('documentNumber') }"
              [attr.aria-invalid]="isFieldInvalid('documentNumber')"
            />
            @if (getFieldError('documentNumber'); as error) {
              <span class="form-field__error">{{ error }}</span>
            }
          </label>

          <label
            class="form-field"
            [ngClass]="{ 'form-field--error': isFieldInvalid('phone') }"
          >
            <span class="form-field__label">Phone</span>
            <input
              type="tel"
              formControlName="phone"
              class="form-field__input"
              autocomplete="tel"
              [ngClass]="{ 'form-field__input--invalid': isFieldInvalid('phone') }"
              [attr.aria-invalid]="isFieldInvalid('phone')"
            />
            @if (getFieldError('phone'); as error) {
              <span class="form-field__error">{{ error }}</span>
            }
          </label>

          <label
            class="form-field"
            [ngClass]="{ 'form-field--error': isFieldInvalid('address') }"
          >
            <span class="form-field__label">Address</span>
            <input
              type="text"
              formControlName="address"
              class="form-field__input"
              [ngClass]="{ 'form-field__input--invalid': isFieldInvalid('address') }"
              [attr.aria-invalid]="isFieldInvalid('address')"
            />
            @if (getFieldError('address'); as error) {
              <span class="form-field__error">{{ error }}</span>
            }
          </label>

          <label class="form-field">
            <span class="form-field__label">Office</span>
            <select formControlName="officeId" class="form-field__input">
              <option value="">No office</option>
              @for (office of offices ?? []; track office.id) {
                <option [value]="office.id">
                  {{ office.nombre }}
                </option>
              }
            </select>
          </label>

          <label class="form-field">
            <span class="form-field__label">Temporary password</span>
            <input type="text" formControlName="password" class="form-field__input" />
          </label>

          <label class="form-field">
            <span class="form-field__label">Birthdate</span>
            <input type="date" formControlName="birthdate" class="form-field__input" />
          </label>

          <label class="form-field">
            <span class="form-field__label">Genero</span>
            <select formControlName="gender" class="form-field__input">
              @for (gender of genderOptions; track gender) {
                <option [value]="gender">{{ gender }}</option>
              }
            </select>
          </label>

          <label class="form-field">
            <span class="form-field__label">Estado civil</span>
            <select formControlName="civilStatus" class="form-field__input">
              <option value="">Seleccione estado civil</option>
              @for (status of civilStatusOptions; track status) {
                <option [value]="status">{{ status }}</option>
              }
            </select>
          </label>

          <label class="form-field">
            <span class="form-field__label">Profession</span>
            <input type="text" formControlName="profession" class="form-field__input" />
          </label>

          <label class="form-field">
            <span class="form-field__label">Nationality</span>
            <input type="text" formControlName="nationality" class="form-field__input" />
          </label>

          <label class="form-field">
            <span class="form-field__label">Children</span>
            <input type="number" formControlName="children" class="form-field__input" />
          </label>

          <label class="form-field">
            <span class="form-field__label">Vehicles</span>
            <input type="number" formControlName="vehicles" class="form-field__input" />
          </label>
        </div>

          <div class="flex flex-wrap items-center justify-between gap-3">
            <a
              [routerLink]="['/admin/companies', company.id, 'users']"
              class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-300 hover:bg-slate-50"
            >
              Back to users
            </a>
            <button
              type="submit"
              [disabled]="isSubmitting()"
              [attr.aria-busy]="isSubmitting()"
              class="inline-flex items-center gap-2 rounded-full bg-sky-600 px-5 py-2 text-sm font-semibold text-white transition hover:bg-sky-700 disabled:cursor-not-allowed disabled:opacity-70"
            >
              Create user
            </button>
          </div>
        </form>
      }

    </article>
  </section>
} @else {
  @if (company === null) {
    <article class="company-form-state-card">
      <p class="company-form-state-card__text">Company not found.</p>
      <a
        routerLink="/admin/companies"
        class="inline-flex w-fit items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-300 hover:bg-slate-50"
      >
        Back to companies
      </a>
    </article>
  } @else {
    <p class="text-sm text-slate-500">Loading company context...</p>
  }
}

<app-confirm-dialog
  [open]="isConfirmationOpen()"
  title="Confirm user creation"
  [description]="confirmationMessage() || 'Are you sure you want to create this user?'"
  confirmText="Create user"
  cancelText="Cancel"
  confirmTone="success"
  icon="success"
  [busy]="isSubmitting()"
  [disableBackdropClose]="isSubmitting()"
  (confirm)="confirmPendingCreation()"
  (cancel)="cancelPendingCreation()"
></app-confirm-dialog>
