@let companyErrorMessage = companyError();
@let company = company$ | async;

@if (companyErrorMessage) {
  <article class="company-overview-state-card">
    <p class="company-overview-state-card__text">{{ companyErrorMessage }}</p>
    <a
      routerLink="/admin/companies"
      class="inline-flex w-fit items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-300 hover:bg-slate-50"
    >
      Volver a la lista de companias
    </a>
  </article>
} @else if (company === undefined) {
  <article class="company-overview-skeleton" aria-hidden="true">
    <div class="company-overview-skeleton__header">
      <div class="skeleton skeleton--avatar"></div>
      <div class="company-overview-skeleton__lines">
        <div class="skeleton skeleton--line skeleton--line-lg"></div>
        <div class="skeleton skeleton--line"></div>
      </div>
    </div>
    <div class="skeleton skeleton--chip"></div>
    <div class="skeleton skeleton--divider"></div>
    <div class="company-overview-skeleton__list">
      @for (_ of skeletonRows; track $index) {
        <div class="skeleton skeleton--line"></div>
      }
    </div>
    <div class="company-overview-skeleton__actions">
      @for (_ of skeletonActions; track $index) {
        <div class="skeleton skeleton--button"></div>
      }
    </div>
  </article>
} @else if (!company) {
  <article class="company-overview-state-card">
    <p class="company-overview-state-card__text">Company not found.</p>
    <a
      routerLink="/admin/companies"
      class="inline-flex w-fit items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-300 hover:bg-slate-50"
    >
      Back to companies
    </a>
  </article>
} @else {
  <app-admin-breadcrumbs
    [items]="[{ label: 'Companies', link: ['/admin/companies'] }, { label: company.name }]"
  ></app-admin-breadcrumbs>

  <section class="space-y-6">
    <article class="flex flex-col gap-6 rounded-3xl border border-slate-200 bg-white p-8 shadow-sm">
      <header class="flex flex-wrap items-start justify-between gap-4">
        <div class="flex items-start gap-4">
          <div class="grid h-14 w-14 place-items-center rounded-2xl bg-gradient-to-br from-sky-400 to-blue-600 text-2xl font-semibold text-white">
            {{ company.name ? company.name.slice(0, 1) : 'C' }}
          </div>
          <div>
            <h1 class="text-2xl font-semibold text-slate-900">{{ company.name }}</h1>
            <p class="text-sm font-medium uppercase tracking-wide text-slate-400">
              Registered with tax id {{ company.taxId }}
            </p>
          </div>
        </div>
        <span
          class="inline-flex items-center rounded-full px-4 py-1.5 text-xs font-semibold uppercase tracking-wide ring-1"
          [ngClass]="
            company.isActive
              ? 'bg-emerald-50 text-emerald-600 ring-emerald-100'
              : 'bg-slate-100 text-slate-500 ring-slate-200'
          "
        >
          {{ company.isActive ? 'Active' : 'Inactive' }}
        </span>
      </header>

      <div class="grid gap-5 md:grid-cols-2">
        <div class="space-y-1">
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Email</p>
          <p class="text-base text-slate-700">{{ company.email }}</p>
        </div>
        <div class="space-y-1">
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Phone</p>
          <p class="text-base text-slate-700">{{ company.phone }}</p>
        </div>
        <div class="space-y-1">
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Default currency</p>
          <p class="text-base text-slate-700">
            {{ company.defaultCurrency || 'Not defined' }}
          </p>
        </div>
        <div class="space-y-1">
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Modules enabled</p>
          <p class="text-base text-slate-700">
            {{ company.modules.length ? company.modules.join(', ') : 'Not configured' }}
          </p>
        </div>
      </div>

      @if (feedback(); as currentFeedback) {
        <p
          class="text-sm font-medium"
          [ngClass]="{
            'text-emerald-600': currentFeedback.tone === 'success',
            'text-red-600': currentFeedback.tone === 'error'
          }"
        >
          {{ currentFeedback.text }}
        </p>
      }

      <footer class="flex flex-wrap justify-end gap-3">
        <a
          [routerLink]="['/admin/companies', company.id, 'users']"
          class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-300 hover:bg-slate-50"
        >
          Manage users
        </a>
        <a
          [routerLink]="['/admin/companies', company.id, 'offices']"
          class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-300 hover:bg-slate-50"
        >
          Create office
        </a>
        <a
          [routerLink]="['/admin/companies', company.id, 'edit']"
          class="inline-flex items-center gap-2 rounded-full bg-sky-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-sky-700"
        >
          Edit company
        </a>
        <button
          type="button"
          (click)="requestCompanyStatusChange(company)"
          [disabled]="isUpdatingStatus()"
          [attr.aria-busy]="isUpdatingStatus()"
          class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-300 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-70"
        >
          {{ company.isActive ? 'Deactivate company' : 'Activate company' }}
        </button>
      </footer>
    </article>

    <article class="flex flex-col gap-6 rounded-3xl border border-slate-200 bg-white p-8 shadow-sm">
      <header class="flex flex-wrap items-start justify-between gap-4">
        <div>
          <h2 class="text-xl font-semibold text-slate-900">Registered offices</h2>
          <p class="text-sm text-slate-500">Every office currently associated with this company.</p>
        </div>
      </header>

      @if (officesFeedback(); as currentOfficesFeedback) {
        <p
          class="text-sm font-medium"
          [ngClass]="{
            'text-emerald-600': currentOfficesFeedback.tone === 'success',
            'text-red-600': currentOfficesFeedback.tone === 'error'
          }"
        >
          {{ currentOfficesFeedback.text }}
        </p>
      }

      @let offices = offices$ | async;

      @if (offices === undefined) {
        <ul class="space-y-4">
          @for (_ of officesSkeleton; track $index) {
            <li class="animate-pulse rounded-2xl border border-slate-200 bg-slate-100/70 p-5 sm:p-6">
              <div class="h-5 w-1/3 rounded-full bg-slate-200"></div>
              <div class="mt-4 space-y-3">
                <div class="h-4 w-2/3 rounded-full bg-slate-200"></div>
                <div class="h-4 w-1/2 rounded-full bg-slate-200"></div>
                <div class="h-4 w-3/5 rounded-full bg-slate-200"></div>
              </div>
            </li>
          }
        </ul>
      } @else {
        <ul class="space-y-4">
          @for (office of offices; track office.id) {
            <li class="rounded-2xl border border-slate-200 bg-slate-50/80 p-5 shadow-sm transition hover:border-slate-300 hover:bg-white/90 sm:p-6">
              <header class="flex flex-wrap items-start justify-between gap-3">
                <div>
                  <h3 class="text-lg font-semibold text-slate-900">{{ office.nombre }}</h3>
                  <p class="text-xs font-medium uppercase tracking-wide text-slate-400">ID {{ office.id }}</p>
                </div>
                <span
                  class="inline-flex items-center rounded-full px-4 py-1 text-xs font-semibold uppercase tracking-wide ring-1"
                  [ngClass]="
                    office.activo
                      ? 'bg-emerald-50 text-emerald-600 ring-emerald-100'
                      : 'bg-slate-100 text-slate-500 ring-slate-200'
                  "
                >
                  {{ office.activo ? 'Active' : 'Inactive' }}
                </span>
              </header>

              <dl class="mt-4 grid gap-4 text-sm text-slate-600 sm:grid-cols-2">
                <div class="space-y-1">
                  <dt class="font-medium text-slate-500">Address</dt>
                  <dd class="text-slate-700">{{ office.direccion || 'Not provided' }}</dd>
                </div>
                <div class="space-y-1">
                  <dt class="font-medium text-slate-500">Phone</dt>
                  <dd class="text-slate-700">{{ office.telefono || 'Not provided' }}</dd>
                </div>
                <div class="space-y-1">
                  <dt class="font-medium text-slate-500">Currency</dt>
                  <dd class="text-slate-700">{{ office.moneda || 'Not specified' }}</dd>
                </div>
                <div class="space-y-1">
                  <dt class="font-medium text-slate-500">Last update</dt>
                  <dd class="text-slate-700">{{ office.fechaActualizacion || 'Unknown' }}</dd>
                </div>
              </dl>

              <footer class="mt-4 flex flex-wrap gap-3">
                <a
                  [routerLink]="['/admin/companies', company.id, 'offices', office.id, 'edit']"
                  class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-300 hover:bg-slate-50"
                >
                  Edit office
                </a>
                <button
                  type="button"
                  (click)="requestOfficeStatusChange(office)"
                  [disabled]="isOfficeUpdating(office.id)"
                  [attr.aria-busy]="isOfficeUpdating(office.id)"
                  class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold transition hover:border-slate-300 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-70"
                  [ngClass]="
                    office.activo
                      ? 'text-red-600 border-red-200 hover:bg-red-50'
                      : 'text-emerald-600 border-emerald-200 hover:bg-emerald-50'
                  "
                >
                  {{ office.activo ? 'Deactivate office' : 'Activate office' }}
                </button>
              </footer>
            </li>
          } @empty {
            @if (officesError(); as officesErrorMessage) {
              <li class="rounded-2xl border border-red-200 bg-red-50 p-5 text-sm font-medium text-red-600">
                {{ officesErrorMessage }}
              </li>
            } @else {
              <li class="rounded-2xl border border-slate-200 bg-white p-6 text-sm text-slate-500">
                No offices registered for this company yet.
              </li>
            }
          }
        </ul>
      }
    </article>
  </section>
}

@let companyAction = pendingCompanyAction();
<app-confirm-dialog
  [open]="!!companyAction"
  title="Confirm company status change"
  [description]="companyConfirmDescription()"
  [confirmText]="companyConfirmActionText()"
  [confirmTone]="companyAction?.nextStatus ? 'success' : 'danger'"
  [icon]="companyAction?.nextStatus ? 'success' : 'danger'"
  [busy]="isUpdatingStatus()"
  (confirm)="confirmCompanyStatusChange()"
  (cancel)="cancelCompanyStatusChange()"
></app-confirm-dialog>

@let officeAction = pendingOfficeAction();
<app-confirm-dialog
  [open]="!!officeAction"
  title="Confirm office status change"
  [description]="officeConfirmDescription()"
  [confirmText]="officeConfirmActionText()"
  [confirmTone]="officeAction?.nextStatus ? 'success' : 'danger'"
  [icon]="officeAction?.nextStatus ? 'success' : 'danger'"
  [busy]="officeConfirmBusy()"
  (confirm)="confirmOfficeStatusChange()"
  (cancel)="cancelOfficeStatusChange()"
></app-confirm-dialog>
