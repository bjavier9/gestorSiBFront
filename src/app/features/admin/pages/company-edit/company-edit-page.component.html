<ng-container *ngIf="company$ | async as company; else loading">
  <ng-container *ngIf="company; else notFound">
    <section class="space-y-6">
      <article class="rounded-3xl border border-slate-200 bg-white p-8 shadow-sm">
        <header class="space-y-2">
          <h1 class="text-2xl font-semibold text-slate-900">Edit company</h1>
          <p class="text-sm text-slate-500">
            Update the main information for {{ company.name }}.
          </p>
        </header>

        <form class="mt-6 space-y-5" [formGroup]="form" (ngSubmit)="submit()">
          <section class="company-logo">
            <figure class="company-logo__preview" aria-labelledby="company-logo-label">
              <img
                [src]="logoPreview()"
                alt="Company logo preview"
                class="company-logo__image"
                (error)="handlePreviewError()"
              />
            </figure>
            <div class="company-logo__content">
              <p id="company-logo-label" class="company-logo__title">Company logo</p>
              <p class="company-logo__description">
                Accepted formats: PNG, JPG, JPEG, GIF, SVG. Maximum size: 300 KB.
              </p>
              <div class="company-logo__actions">
                <label class="company-logo__upload">
                  <input
                    type="file"
                    class="company-logo__input"
                    accept=".png,.jpg,.jpeg,.gif,.svg,image/png,image/jpeg,image/gif,image/svg+xml"
                    (change)="onLogoSelected($event)"
                  />
                  <span class="company-logo__upload-text">Change logo</span>
                </label>
                <button
                  type="button"
                  class="company-logo__action company-logo__action--ghost"
                  (click)="removeLogo()"
                  [disabled]="logoState() === 'removed'"
                >
                  Remove logo
                </button>
                <button
                  type="button"
                  class="company-logo__action company-logo__action--secondary"
                  (click)="resetLogoChanges()"
                  *ngIf="logoState() !== 'unchanged'"
                >
                  Undo changes
                </button>
              </div>
              <p *ngIf="logoError()" class="company-logo__error">
                {{ logoError() }}
              </p>
            </div>
          </section>

          <div class="grid gap-5 md:grid-cols-2">
            <label class="company-field">
              <span class="company-field__label">Name</span>
              <input
                type="text"
                formControlName="name"
                autocomplete="organization"
                class="company-field__input"
              />
            </label>

            <label class="company-field">
              <span class="company-field__label">Tax id</span>
              <input
                type="text"
                formControlName="taxId"
                autocomplete="off"
                class="company-field__input"
              />
            </label>

            <label class="company-field">
              <span class="company-field__label">Email</span>
              <input
                type="email"
                formControlName="email"
                autocomplete="email"
                class="company-field__input"
              />
            </label>

            <label class="company-field">
              <span class="company-field__label">Phone</span>
              <input
                type="tel"
                formControlName="phone"
                autocomplete="tel"
                class="company-field__input"
              />
            </label>
          </div>

          <label class="company-field">
            <span class="company-field__label">Address</span>
            <input
              type="text"
              formControlName="address"
              autocomplete="street-address"
              class="company-field__input"
            />
          </label>

          <div class="flex flex-wrap items-center justify-between gap-3">
            <a
              [routerLink]="['/admin/companies', company.id]"
              class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-300 hover:bg-slate-50"
            >
              ‚Üê Back to company overview
            </a>
            <button
              type="submit"
              [disabled]="isSubmitting()"
              [attr.aria-busy]="isSubmitting()"
              class="inline-flex items-center gap-2 rounded-full bg-sky-600 px-5 py-2 text-sm font-semibold text-white transition hover:bg-sky-700 disabled:cursor-not-allowed disabled:opacity-70"
            >
              <span aria-hidden="true">üíæ</span>
              Save changes
            </button>
          </div>
        </form>

        <p
          *ngIf="feedback() as currentFeedback"
          class="mt-6 text-sm font-medium"
          [ngClass]="{
            'text-emerald-600': currentFeedback.tone === 'success',
            'text-red-600': currentFeedback.tone === 'error'
          }"
        >
          {{ currentFeedback.text }}
        </p>
      </article>
    </section>
  </ng-container>
</ng-container>

<ng-container *ngIf="isConfirmationOpen()">
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 px-4">
    <div
      class="w-full max-w-lg rounded-3xl border border-slate-200 bg-white p-8 shadow-xl"
      role="dialog"
      aria-modal="true"
      aria-labelledby="edit-company-confirmation-title"
    >
      <h2 id="edit-company-confirmation-title" class="text-xl font-semibold text-slate-900">
        Confirm changes
      </h2>
      <p class="mt-3 text-sm text-slate-600">
        {{ confirmationMessage() || 'Are you sure you want to apply these changes?' }}
      </p>
      <div class="mt-6 flex justify-end gap-3">
        <button
          type="button"
          (click)="cancelPendingUpdate()"
          class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-300 hover:bg-slate-50"
        >
          Cancel
        </button>
        <button
          type="button"
          (click)="confirmPendingUpdate()"
          [disabled]="isSubmitting()"
          [attr.aria-busy]="isSubmitting()"
          class="inline-flex items-center gap-2 rounded-full bg-sky-600 px-5 py-2 text-sm font-semibold text-white transition hover:bg-sky-700"
        >
          Confirm
        </button>
      </div>
    </div>
  </div>
</ng-container>

<ng-template #loading>
  <article class="company-form-skeleton" aria-hidden="true">
    <div class="skeleton skeleton--title"></div>
    <div class="skeleton skeleton--subtitle"></div>
    <div class="company-form-skeleton__fields">
      <div class="skeleton skeleton--field" *ngFor="let _ of skeletonFields"></div>
    </div>
    <div class="company-form-skeleton__actions">
      <div class="skeleton skeleton--button" *ngFor="let _ of skeletonActions"></div>
    </div>
  </article>
</ng-template>

<ng-template #notFound>
  <article class="company-form-state-card">
    <p class="company-form-state-card__text">Company not found.</p>
    <a
      routerLink="/admin/companies"
      class="inline-flex w-fit items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-300 hover:bg-slate-50"
    >
      ‚Üê Back to companies
    </a>
  </article>
</ng-template>
