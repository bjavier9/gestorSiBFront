@if (company$ | async; as company) {
  @if (company) {
    <section class="space-y-6">
      <app-admin-breadcrumbs
        [items]="[
          { label: 'Companies', link: ['/admin/companies'] },
          { label: company.name, link: ['/admin/companies', company.id] },
          { label: 'Users' }
        ]"
      ></app-admin-breadcrumbs>

      <article class="rounded-3xl border border-slate-200 bg-white p-8 shadow-sm">
        <header class="flex flex-wrap items-start justify-between gap-4">
          <div>
            <h1 class="text-2xl font-semibold text-slate-900">Users for {{ company.name }}</h1>
            <p class="text-sm text-slate-500">
              Review every user assigned to this brokerage and manage their access status.
            </p>
          </div>
          <a
            [routerLink]="['/admin/companies', company.id, 'users', 'create']"
            class="inline-flex items-center gap-2 rounded-full bg-sky-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-sky-700"
          >
            Create user
          </a>
        </header>

        @if (usersFeedback(); as currentUsersFeedback) {
          <p
            class="mt-4 text-sm font-medium"
            [ngClass]="{
              'text-emerald-600': currentUsersFeedback.tone === 'success',
              'text-red-600': currentUsersFeedback.tone === 'error'
            }"
          >
            {{ currentUsersFeedback.text }}
          </p>
        }

        <div class="mt-6 space-y-4">
          @if (isUsersLoading()) {
            <ul class="space-y-4" aria-hidden="true">
              <li class="animate-pulse rounded-2xl border border-slate-200 bg-slate-100/70 p-5">
                <div class="h-4 w-1/3 rounded-full bg-slate-200"></div>
                <div class="mt-3 h-4 w-1/4 rounded-full bg-slate-200"></div>
              </li>
              <li class="animate-pulse rounded-2xl border border-slate-200 bg-slate-100/70 p-5">
                <div class="h-4 w-2/5 rounded-full bg-slate-200"></div>
                <div class="mt-3 h-4 w-1/3 rounded-full bg-slate-200"></div>
              </li>
            </ul>
          } @else {
            @if (usersError()) {
              <p class="rounded-2xl border border-red-200 bg-red-50 p-4 text-sm font-medium text-red-600">
                {{ usersError() }}
              </p>
            } @else {
              @if (users().length) {
                <ul class="space-y-4">
                  @for (user of users(); track user.id) {
                    <li
                      class="flex flex-col gap-4 rounded-2xl border border-slate-200 bg-slate-50/80 p-5 shadow-sm transition hover:border-slate-300 hover:bg-white/90 md:flex-row md:items-center md:justify-between"
                    >
                      <div class="space-y-1">
                        <p class="text-base font-semibold text-slate-900">{{ user.email }}</p>
                        <p class="text-sm text-slate-500">
                          Role - <span class="capitalize">{{ user.rol }}</span>
                        </p>
                        <p class="text-xs uppercase tracking-wide text-slate-400">ID {{ user.id }}</p>
                      </div>
                      <div class="flex flex-wrap items-center gap-3">
                        <span
                          class="inline-flex items-center rounded-full px-4 py-1 text-xs font-semibold uppercase tracking-wide ring-1"
                          [ngClass]="
                            user.activo
                              ? 'bg-emerald-50 text-emerald-600 ring-emerald-100'
                              : 'bg-slate-100 text-slate-500 ring-slate-200'
                          "
                        >
                          {{ user.activo ? 'Active' : 'Inactive' }}
                        </span>
                        <button
                          type="button"
                          (click)="requestUserStatusChange(user)"
                          [disabled]="userStatusLoading()[user.id]"
                          [attr.aria-busy]="userStatusLoading()[user.id]"
                          class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold transition hover:border-slate-300 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-70"
                          [ngClass]="
                            user.activo
                              ? 'text-red-600 border-red-200 hover:bg-red-50'
                              : 'text-emerald-600 border-emerald-200 hover:bg-emerald-50'
                          "
                        >
                          {{ user.activo ? 'Deactivate' : 'Activate' }}
                        </button>
                      </div>
                    </li>
                  }
                </ul>
              } @else {
                <p class="rounded-2xl border border-slate-200 bg-white p-6 text-sm text-slate-500">
                  No users registered for this company yet. Use the button above to create the first one.
                </p>
              }
            }
          }
        </div>
      </article>
    </section>
  } @else {
    <article class="company-form-state-card">
      <p class="company-form-state-card__text">Company not found.</p>
      <a
        routerLink="/admin/companies"
        class="inline-flex w-fit items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-300 hover:bg-slate-50"
      >
        Back to companies
      </a>
    </article>
  }
} @else {
  <article class="company-users-skeleton" aria-hidden="true">
    @for (_ of skeletonCards; track $index) {
      <div class="company-users-skeleton__card"></div>
    }
  </article>
}

@let pendingAction = pendingUserAction();
<app-confirm-dialog
  [open]="!!pendingAction"
  title="Confirm user status change"
  [description]="userConfirmDescription()"
  [confirmText]="userConfirmActionText()"
  [confirmTone]="pendingAction?.nextStatus ? 'success' : 'danger'"
  [icon]="pendingAction?.nextStatus ? 'success' : 'danger'"
  [busy]="userConfirmBusy()"
  [disableBackdropClose]="userConfirmBusy()"
  (confirm)="confirmUserStatusChange()"
  (cancel)="cancelUserStatusChange()"
></app-confirm-dialog>
